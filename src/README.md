# キャッシュ機能の実装について

このプロジェクトでは、API リクエストの負荷を軽減するために、キャッシュ機能を実装しています。

## 主な機能

- API リクエストのレスポンスを 3 時間キャッシュします
- 同一パラメータのリクエストが 3 時間以内に行われた場合、キャッシュされたデータを返します
- キャッシュが期限切れになると、新しい API リクエストを行い、結果を再キャッシュします
- **ページロード時に最初にキャッシュを確認し、キャッシュがあれば使用します**
- **キャッシュは localStorage に保存され、ブラウザを閉じた後も保持されます**

## 使用方法

キャッシュサービスは`src/utils/cacheUtils.ts`に実装されています。このサービスは以下のメソッドを提供します：

- `get<T>(key: string): T | null` - キャッシュからデータを取得します
- `set<T>(key: string, data: T): void` - データをキャッシュに保存します
- `remove(key: string): void` - 特定のキャッシュを削除します
- `clear(): void` - すべてのキャッシュをクリアします
- `getAllCacheKeys(): string[]` - すべてのキャッシュキーを取得します
- `getCacheStatus(): { key: string; age: string; size: number }[]` - キャッシュの現在の状態を取得します
- `logCacheStatus(): void` - キャッシュの現在の状態をコンソールに出力します

現在、キャッシュは`getElectricityUsage`メソッドに適用されています。他の API リクエストメソッドにも同様の実装を追加することができます。

## ページロード時のキャッシュ確認

ページが読み込まれたとき（`ElectricityUsageDashboard`コンポーネントがマウントされたとき）、最初に必ずキャッシュを確認します：

1. 初回ロード時に`initialLoadRef`を使用して、キャッシュチェックが最初に実行されるようにします
2. キャッシュが存在する場合は、API リクエストをせずにキャッシュからデータを直接表示します
3. 次と前のデータもキャッシュを確認し、キャッシュがある場合はキャッシュから取得します
4. キャッシュがない場合のみ、API リクエストを送信します
5. 初回ロードが完了したことを示す`initialLoadCompleteRef`フラグを設定し、通常のデータロードが実行できるようにします

この実装により、ページ読み込み時に不要な API リクエストを行わず、キャッシュを最大限に活用できます。

## キャッシュの永続化

キャッシュは`localStorage`に保存されるため、以下の特性があります：

- ブラウザを閉じても保持されます
- 異なるタブやウィンドウ間では共有されません
- クリアするまで保持されます（ブラウザキャッシュのクリアでも削除されます）
- セッションをまたいで（ブラウザを再起動しても）保持されます

これにより、ユーザーはアプリを再度開いた際に、前回のデータをすぐに表示できます。

## キャッシュの有効期限

デフォルトのキャッシュ有効期限は 3 時間です。これは`cacheUtils.ts`の`defaultOptions.expirationTime`で設定されています。

## デバッグ機能

キャッシュの動作を確認するために、以下のデバッグ機能が実装されています：

- キャッシュ操作（読み取り、書き込み、削除）時に詳細なログを出力
- キャッシュキーの短縮表示
- キャッシュデータのサイズと残り有効時間の表示
- キャッシュの全体状態（キー数と合計サイズ）の表示

## トラブルシューティング

### キャッシュからデータを読み込んでもグラフが表示されない

この問題は、キャッシュされたデータのうち日付型の情報が文字列として保存されていたために発生していました。解決策として以下の対応を行いました：

1. `HalfHourlyReading`インターフェースの`startAt`フィールドを`string | Date`型に変更
2. キャッシュからのデータ読み込み時に JSON.parse のリバイバー関数を使用して日付文字列を Date オブジェクトに変換
3. データ処理関数（`groupByDay`, `groupByMonth`, `calculateYearlyData`, `formatData`）で string 型と Date 型の両方に対応
4. localStorage に保存する前に文字列に変換され、読み込み時に再構築されるデータ構造を適切に処理

キャッシュによる問題が発生した場合は、以下の方法で対処できます：

- ブラウザのコンソールで`cacheService.clear()`を実行してキャッシュをクリアする
- ブラウザの開発者ツールの「アプリケーション」タブから localStorage を確認し、`energy_forecast_cache`エントリを削除する
- コンソールログを確認して、キャッシュの状態とデータ変換過程を確認する
